
# Include debconf shell utility library
. /usr/share/debconf/confmodule

# Define and initialize constants.
readonly NETPLAN_ORIGIN_FILE_NAME=10-network-netremote-all
readonly NETPLAN_ORIGIN_FILE_PATH=/etc/netplan/${NETPLAN_ORIGIN_FILE_NAME}.yaml
readonly NETPLAN_ORIGIN_FILE_PERMS=0600
readonly NETPLAN_KEY_RENDERER=renderer
readonly NETPLAN_RENDERER=networkd

# Below expression to enumerate ethernet interfaces assumes stable interface name generation via systemd-udevd with
# default policy is active in which all ethernet interface names are prefixed with "en".
# 
# Refer to https://www.freedesktop.org/software/systemd/man/latest/systemd.net-naming-scheme.html for complete details.
# 
readonly ETHERNET_INTERFACES=$(find -L /sys/class/net -mindepth 1 -maxdepth 1 -type d -name "en*" -printf "%f " | xargs -n1 | sort | xargs)

readonly QUESTION_NETWORK_BRIDGES=netremote/network/bridge-interfaces
readonly QUESTION_NETWORK_BRIDGE_CHOICES=$(echo ${ETHERNET_INTERFACES// /, } | head -c-1)
readonly QUESTION_NETWORK_BRIDGE_CHOICES_VAR=network-bridge-interfaces-choices

# Set a key-value pair in the netplan configuration file.
#
# The netplan configuration file referred to by NETPLAN_ORIGIN_FILE_NAME is used.
#
# Arguments:
#   Key to set ($1)
#   Value to set ($2)
#
function netplan_configuration_set_key_value() {
    local key
    local value
    key="${1}"
    value="${2}"
    netplan set --origin-hint ${NETPLAN_ORIGIN_FILE_NAME} ${key}=${value}
}

# Set the top-level (global) fields in the netplan configuration file.
#
# The netplan configuration file referred to by NETPLAN_ORIGIN_FILE_NAME is used.
#
# Arguments:
#   None
#
function netplan_file_set_toplevel_fields() {
    netplan_configuration_set_key_value ${NETPLAN_KEY_RENDERER} ${NETPLAN_RENDERER}
}

# Create the netplan configuration file if it does not exist, and set top-level fields.
#
# The netplan configuration file referred to by NETPLAN_ORIGIN_FILE_NAME is used.
#
# Arguments:
#   None
# 
function netplan_configuration_create() {
    if [[ ! -f ${NETPLAN_ORIGIN_FILE_PATH} ]]; then
        install -m ${NETPLAN_ORIGIN_FILE_PERMS} /dev/null ${NETPLAN_ORIGIN_FILE_PATH}
        netplan_file_set_toplevel_fields
    fi
}



